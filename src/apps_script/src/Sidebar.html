<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding: 12px;
        font-family: Arial, sans-serif;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input, textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      textarea.json-schema {
        height: 150px;
        min-height: 150px;
        font-size: 11px;
        font-family: monospace;
      }
      button {
        background-color: #4285f4;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background-color: #3b78e7;
      }
      .alert {
        padding: 12px;
        margin-top: 15px;
        display: none;
        border-radius: 4px;
      }
      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .hidden {
        display: none;
      }
      .spinner {
        display: none;
        text-align: center;
        margin-top: 15px;
      }
      .advanced-toggle {
        cursor: pointer;
        padding: 8px;
        background-color: #f1f1f1;
        border-radius: 4px;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .advanced-toggle:hover {
        background-color: #e7e7e7;
      }
      .advanced-options {
        display: none;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .example-button {
        font-size: 10px;
        padding: 4px 8px;
        margin-top: 5px;
        display: inline-block;
        background-color: #f1f1f1;
        color: #333;
      }
      .hint-text {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-0">
      <div class="row">
        <div class="col">
          <h4 class="mb-3">Humble Clay</h4>
        </div>
      </div>
      
      <form id="promptForm">
        <div class="form-group">
          <label for="inputRange">Input Range *</label>
          <input type="text" id="inputRange" placeholder="e.g., A1:A10" required>
        </div>
        <div class="form-group">
          <label for="outputColumn">Output Column *</label>
          <input type="text" id="outputColumn" placeholder="e.g., B" required>
        </div>
        
        <div class="form-group">
          <label for="simpleField">Output Field (Optional)</label>
          <input type="text" id="simpleField" placeholder="e.g., age: int, status: [active, pending]">
          <div class="hint-text">Examples: company_name, age: int, is_active: bool, status: [active, pending]</div>
        </div>
        
        <div class="advanced-toggle" id="advancedToggle">
          ▶ Advanced Options
        </div>
        
        <div class="advanced-options" id="advancedOptions">
          <div class="form-group">
            <label for="jsonSchema">Output JSON Schema (Optional)</label>
            <textarea id="jsonSchema" class="json-schema" placeholder="Enter a valid JSON schema to define the structure of the LLM response"></textarea>
            <button type="button" id="showExampleSchema" class="example-button">Show example</button>
          </div>
          <div class="form-group">
            <label for="fieldPath">Extract Field Path (Optional)</label>
            <input type="text" id="fieldPath" placeholder="e.g., user.name or skills[0]">
          </div>
        </div>
        
        <button type="submit" id="generateButton">Generate Output</button>
      </form>
      
      <div class="spinner" id="spinner">
        <img src="https://www.gstatic.com/images/icons/material/system/1x/sync_black_20dp.png" width="20" height="20">
        Processing...
      </div>
      
      <div class="alert alert-success" id="successAlert"></div>
      <div class="alert alert-error" id="errorAlert"></div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Client-side validation and interaction -->
    <script>
      // Function to get URL parameter
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      // Function to validate JSON
      function isValidJson(json) {
        if (!json) return true; // Empty is valid
        try {
          JSON.parse(json);
          return true;
        } catch (e) {
          return false;
        }
      }
      
      document.getElementById('advancedToggle').addEventListener('click', function() {
        var options = document.getElementById('advancedOptions');
        if (options.style.display === 'block') {
          options.style.display = 'none';
          this.innerHTML = '▶ Advanced Options';
        } else {
          options.style.display = 'block';
          this.innerHTML = '▼ Advanced Options';
        }
      });
      
      document.getElementById('showExampleSchema').addEventListener('click', function() {
        var example = {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "age": { "type": "number" },
            "skills": { 
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "required": ["name", "age"]
        };
        document.getElementById('jsonSchema').value = JSON.stringify(example, null, 2);
      });

      // Function to parse simple field syntax and update schema and field path
      function updateSchemaFromSimpleField() {
        var simpleField = document.getElementById('simpleField').value.trim();
        var jsonSchemaField = document.getElementById('jsonSchema');
        var fieldPathField = document.getElementById('fieldPath');
        
        // Only proceed if simpleField has a value
        if (simpleField) {
          // Clear existing values in advanced fields
          if (jsonSchemaField.value) {
            jsonSchemaField.value = '';
          }
          if (fieldPathField.value) {
            fieldPathField.value = '';
          }
          
          // Try to load the SimpleOutputField functions
          try {
            // Call the parseSimpleSyntax function
            var parsedSyntax = parseSimpleSyntax(simpleField);
            
            if (parsedSyntax) {
              // Generate schema
              var schema = generateSchemaFromSyntax(parsedSyntax);
              if (schema) {
                jsonSchemaField.value = JSON.stringify(schema, null, 2);
              }
              
              // Set field path
              var fieldPath = extractFieldPathFromSyntax(parsedSyntax);
              if (fieldPath) {
                fieldPathField.value = fieldPath;
              }
            }
          } catch (e) {
            console.error('Error processing simple field:', e);
            // Don't show error to user - just leave advanced fields empty
          }
        }
      }

      // Listen for changes to the simple field
      document.getElementById('simpleField').addEventListener('blur', updateSchemaFromSimpleField);
      
      // Listen for changes to advanced fields to clear simple field
      document.getElementById('jsonSchema').addEventListener('input', function() {
        if (this.value && document.getElementById('simpleField').value) {
          document.getElementById('simpleField').value = '';
        }
      });
      
      document.getElementById('fieldPath').addEventListener('input', function() {
        if (this.value && document.getElementById('simpleField').value) {
          document.getElementById('simpleField').value = '';
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        // Initialize form with URL parameters if present
        var inputRange = getUrlParameter('inputRange');
        var outputColumn = getUrlParameter('outputColumn');
        
        if (inputRange) document.getElementById('inputRange').value = inputRange;
        if (outputColumn) document.getElementById('outputColumn').value = outputColumn;
        
        // Form submission handler
        document.getElementById('promptForm').addEventListener('submit', function(e) {
          e.preventDefault();
          
          var inputRange = document.getElementById('inputRange').value;
          var outputColumn = document.getElementById('outputColumn').value;
          var simpleField = document.getElementById('simpleField').value;
          var jsonSchema = document.getElementById('jsonSchema').value;
          var fieldPath = document.getElementById('fieldPath').value;
          
          // Basic validation
          if (!inputRange || !outputColumn) {
            showError('Please fill in all required fields.');
            return;
          }
          
          // Process simple field if provided (and advanced options aren't)
          if (simpleField && (!jsonSchema && !fieldPath)) {
            updateSchemaFromSimpleField();
            jsonSchema = document.getElementById('jsonSchema').value;
            fieldPath = document.getElementById('fieldPath').value;
          }
          
          // Validate schema if provided
          if (jsonSchema && !isValidJson(jsonSchema)) {
            showError('Invalid JSON schema. Please check your format.');
            return;
          }
          
          // Validate field path only allowed if schema is provided
          if (fieldPath && !jsonSchema) {
            showError('Field path can only be used when a JSON schema is provided.');
            return;
          }
          
          // Show spinner
          document.getElementById('spinner').style.display = 'block';
          
          // Hide previous alerts
          document.getElementById('successAlert').style.display = 'none';
          document.getElementById('errorAlert').style.display = 'none';
          
          // Prepare schema object if provided
          var schemaObj = jsonSchema ? JSON.parse(jsonSchema) : null;
          
          // Call the server-side function
          google.script.run
            .withSuccessHandler(function(result) {
              // Hide spinner
              document.getElementById('spinner').style.display = 'none';
              
              if (result.success) {
                showSuccess(result.message);
              } else {
                showError(result.message);
              }
            })
            .withFailureHandler(function(error) {
              // Hide spinner
              document.getElementById('spinner').style.display = 'none';
              showError('Error: ' + error.message);
            })
            .processRange(inputRange, outputColumn, schemaObj, fieldPath);
        });
      });
      
      function showSuccess(message) {
        var alert = document.getElementById('successAlert');
        alert.textContent = message;
        alert.style.display = 'block';
      }
      
      function showError(message) {
        var alert = document.getElementById('errorAlert');
        alert.textContent = message;
        alert.style.display = 'block';
      }
    </script>
  </body>
</html> 