<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding: 15px;
        font-family: Arial, sans-serif;
      }
      .form-label {
        font-weight: 500;
        margin-bottom: 0.3rem;
      }
      .alert {
        display: none;
        margin-top: 1rem;
      }
      .form-text {
        font-size: 0.8rem;
        color: #6c757d;
      }
      #generateBtn {
        margin-top: 1rem;
        width: 100%;
      }
      .loading {
        display: none;
        margin-left: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-0">
      <div class="row">
        <div class="col">
          <h4 class="mb-3">Humble Clay</h4>
        </div>
      </div>
      
      <form id="rangeForm">
        <!-- Input Range -->
        <div class="mb-3">
          <label for="inputRange" class="form-label">Input Range</label>
          <input type="text" 
                 class="form-control" 
                 id="inputRange" 
                 placeholder="e.g., A1:A10"
                 required
                 pattern="^[A-Z]{1,2}\d+:[A-Z]{1,2}\d+$">
          <div class="form-text">
            Enter a valid range in A1 notation (e.g., A1:A10)
          </div>
          <div class="invalid-feedback">
            Please enter a valid range (e.g., A1:A10)
          </div>
        </div>

        <!-- Output Column -->
        <div class="mb-3">
          <label for="outputColumn" class="form-label">Output Column</label>
          <input type="text" 
                 class="form-control" 
                 id="outputColumn" 
                 placeholder="e.g., C"
                 required
                 pattern="^[A-Z]{1,2}$">
          <div class="form-text">
            Enter a column letter (A-Z or AA-ZZ)
          </div>
          <div class="invalid-feedback">
            Please enter a valid column letter
          </div>
        </div>

        <!-- Advanced Options (Collapsible) -->
        <div class="mb-3">
          <a class="text-decoration-none" data-bs-toggle="collapse" href="#advancedOptions" role="button" aria-expanded="false" aria-controls="advancedOptions">
            <h6><i class="bi bi-chevron-right"></i> Advanced Options</h6>
          </a>
          <div class="collapse" id="advancedOptions">
            <div class="card card-body mt-2">
              <!-- JSON Schema -->
              <div class="mb-3">
                <label for="jsonSchema" class="form-label">Output JSON Schema (Optional)</label>
                <textarea class="form-control" 
                        id="jsonSchema" 
                        rows="4"
                        placeholder='e.g., {"type": "object", "properties": {"name": {"type": "string"}}}'></textarea>
                <div class="form-text">
                  Define the structure of the LLM response using a valid JSON schema
                </div>
                <div class="invalid-feedback">
                  Please enter a valid JSON schema
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-1" id="schemaExampleBtn">
                  Show Example Schema
                </button>
              </div>
              
              <!-- Field Path -->
              <div class="mb-3">
                <label for="fieldPath" class="form-label">Extract Field Path (Optional)</label>
                <input type="text" 
                      class="form-control" 
                      id="fieldPath" 
                      placeholder="e.g., user.name or items[0].id">
                <div class="form-text">
                  Specify a path to extract a specific field from the JSON response (only works with schema)
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Generate Button -->
        <button type="submit" 
                class="btn btn-primary" 
                id="generateBtn">
          Generate Output
          <span class="spinner-border spinner-border-sm loading" role="status">
            <span class="visually-hidden">Loading...</span>
          </span>
        </button>
      </form>

      <!-- Success Alert -->
      <div class="alert alert-success" role="alert" id="successAlert">
        Output generated successfully!
      </div>

      <!-- Error Alert -->
      <div class="alert alert-danger" role="alert" id="errorAlert">
        An error occurred. Please check your input and try again.
      </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Client-side validation and interaction -->
    <script>
      // Initialize form validation
      const form = document.getElementById('rangeForm');
      const inputRange = document.getElementById('inputRange');
      const outputColumn = document.getElementById('outputColumn');
      const jsonSchema = document.getElementById('jsonSchema');
      const fieldPath = document.getElementById('fieldPath');
      const schemaExampleBtn = document.getElementById('schemaExampleBtn');
      const generateBtn = document.getElementById('generateBtn');
      const successAlert = document.getElementById('successAlert');
      const errorAlert = document.getElementById('errorAlert');
      const loadingSpinner = document.querySelector('.loading');

      // Schema example button handler
      schemaExampleBtn.addEventListener('click', function() {
        const exampleSchema = {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "age": { "type": "number" },
            "skills": { 
              "type": "array", 
              "items": { "type": "string" } 
            }
          },
          "required": ["name"]
        };
        jsonSchema.value = JSON.stringify(exampleSchema, null, 2);
      });

      // Form submission handler
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Reset alerts
        successAlert.style.display = 'none';
        errorAlert.style.display = 'none';

        if (!form.checkValidity()) {
          event.stopPropagation();
          form.classList.add('was-validated');
          return;
        }

        // Validate JSON schema if provided
        let schema = null;
        if (jsonSchema.value.trim()) {
          try {
            schema = JSON.parse(jsonSchema.value);
          } catch (e) {
            errorAlert.textContent = "Invalid JSON Schema: " + e.message;
            errorAlert.style.display = 'block';
            return;
          }
        }

        // Validate field path (only allow if schema is provided)
        let path = fieldPath.value.trim();
        if (path && !schema) {
          errorAlert.textContent = "Field path can only be used with a schema";
          errorAlert.style.display = 'block';
          return;
        }

        // Show loading state
        generateBtn.disabled = true;
        loadingSpinner.style.display = 'inline-block';

        // Call Google Apps Script function with schema and field path
        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onError)
          .processRange(inputRange.value, outputColumn.value, schema, path);
      });

      // Success handler
      function onSuccess(result) {
        generateBtn.disabled = false;
        loadingSpinner.style.display = 'none';
        successAlert.style.display = 'block';
        form.reset();
        form.classList.remove('was-validated');
      }

      // Error handler
      function onError(error) {
        generateBtn.disabled = false;
        loadingSpinner.style.display = 'none';
        errorAlert.textContent = error.message || 'An error occurred. Please try again.';
        errorAlert.style.display = 'block';
      }

      // Real-time validation
      inputRange.addEventListener('input', function() {
        const isValid = this.checkValidity();
        if (isValid) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else {
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        }
      });

      outputColumn.addEventListener('input', function() {
        const isValid = this.checkValidity();
        if (isValid) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else {
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        }
      });
    </script>
  </body>
</html> 