<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding: 10px;
        font-family: Arial, sans-serif;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .hint {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 3px;
      }
      #spinner {
        display: none;
        text-align: center;
        padding: 15px;
      }
      .alert {
        display: none;
        margin-top: 15px;
      }
      .accordion-button {
        padding: 0.5rem 1.25rem;
        font-size: 0.9rem;
      }
      .accordion-body {
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-0">
      <h4>Humble Clay</h4>
      <p class="small text-muted">Process text with AI and extract structured data</p>
      
      <form id="promptForm">
        <div class="form-group">
          <label for="inputRange">Input Range <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="inputRange" placeholder="e.g., A1:A10" required>
          <div class="hint">The range containing your input text</div>
        </div>
        
        <div class="form-group">
          <label for="outputColumn">Output Column <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="outputColumn" placeholder="e.g., B" required>
          <div class="hint">The column where results will be placed</div>
        </div>
        
        <div class="form-group">
          <label for="simpleField">Output Field (Optional)</label>
          <input type="text" class="form-control" id="simpleField" placeholder="e.g., age: int, status: [active, pending]">
          <div class="hint">Simplified field syntax for schema generation. Examples:<br>
            <code>field_name</code> - Simple string field<br>
            <code>age: int</code> - Integer field<br>
            <code>status: [active, pending]</code> - Enum field
          </div>
        </div>
        
        <div class="accordion mb-3">
          <div class="accordion-item">
            <h2 class="accordion-header" id="advancedOptionsHeading">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions" aria-expanded="false" aria-controls="advancedOptions">
                Advanced Options
              </button>
            </h2>
            <div id="advancedOptions" class="accordion-collapse collapse" aria-labelledby="advancedOptionsHeading">
              <div class="accordion-body">
                <div class="form-group">
                  <label for="jsonSchema">JSON Schema (Optional)</label>
                  <textarea class="form-control" id="jsonSchema" rows="6" placeholder='{"type": "object", "properties": {...}}' style="font-family: monospace;"></textarea>
                  <div class="hint">Structured schema for response formatting</div>
                </div>
                
                <div class="form-group">
                  <label for="fieldPath">Field Path (Optional)</label>
                  <input type="text" class="form-control" id="fieldPath" placeholder="e.g., name">
                  <div class="hint">Path to extract from the response</div>
                </div>
                
                <button type="button" id="schemaExample" class="btn btn-sm btn-outline-secondary mt-2">
                  Insert Example Schema
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100">Process Range</button>
      </form>
      
      <div id="spinner" class="mt-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Processing, please wait...</p>
      </div>
      
      <div id="successAlert" class="alert alert-success mt-3"></div>
      <div id="errorAlert" class="alert alert-danger mt-3"></div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      // Initialize SimpleOutputField functions from server-side
      <?!= simpleOutputFieldInit ?>
      
      function getUrlParameter(name) {
        var params = new URLSearchParams(window.location.search);
        return params.get(name);
      }
      
      function isValidJson(json) {
        try {
          JSON.parse(json);
          return true;
        } catch (e) {
          return false;
        }
      }
      
      // Insert example schema
      document.getElementById('schemaExample').addEventListener('click', function() {
        const example = {
          "type": "object",
          "properties": {
            "name": {
              "type": "string"
            },
            "age": {
              "type": "integer"
            }
          },
          "required": ["name", "age"]
        };
        document.getElementById('jsonSchema').value = JSON.stringify(example, null, 2);
      });

      // Function to parse simple field syntax and update schema and field path
      function updateSchemaFromSimpleField() {
        var simpleField = document.getElementById('simpleField').value.trim();
        var jsonSchemaField = document.getElementById('jsonSchema');
        var fieldPathField = document.getElementById('fieldPath');
        
        // Only proceed if simpleField has a value
        if (simpleField) {
          // Clear existing values in advanced fields
          if (jsonSchemaField.value) {
            jsonSchemaField.value = '';
          }
          if (fieldPathField.value) {
            fieldPathField.value = '';
          }
          
          // Try to load the SimpleOutputField functions
          try {
            // Call the parseSimpleSyntax function
            var parsedSyntax = parseSimpleSyntax(simpleField);
            
            if (parsedSyntax) {
              // Generate schema
              var schema = generateSchemaFromSyntax(parsedSyntax);
              if (schema) {
                jsonSchemaField.value = JSON.stringify(schema, null, 2);
              }
              
              // Set field path
              var fieldPath = extractFieldPathFromSyntax(parsedSyntax);
              if (fieldPath) {
                fieldPathField.value = fieldPath;
              }
            }
          } catch (e) {
            console.error('Error processing simple field:', e);
            // Don't show error to user - just leave advanced fields empty
          }
        }
      }

      // Listen for changes to the simple field
      document.getElementById('simpleField').addEventListener('blur', updateSchemaFromSimpleField);
      
      // Listen for changes to advanced fields to clear simple field
      document.getElementById('jsonSchema').addEventListener('input', function() {
        if (this.value && document.getElementById('simpleField').value) {
          document.getElementById('simpleField').value = '';
        }
      });
      
      document.getElementById('fieldPath').addEventListener('input', function() {
        if (this.value && document.getElementById('simpleField').value) {
          document.getElementById('simpleField').value = '';
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        // Initialize form with URL parameters if present
        var inputRange = getUrlParameter('inputRange');
        var outputColumn = getUrlParameter('outputColumn');
        
        if (inputRange) document.getElementById('inputRange').value = inputRange;
        if (outputColumn) document.getElementById('outputColumn').value = outputColumn;
        
        // Form submission handler
        document.getElementById('promptForm').addEventListener('submit', function(e) {
          e.preventDefault();
          
          var inputRange = document.getElementById('inputRange').value;
          var outputColumn = document.getElementById('outputColumn').value;
          var simpleField = document.getElementById('simpleField').value;
          var jsonSchema = document.getElementById('jsonSchema').value;
          var fieldPath = document.getElementById('fieldPath').value;
          
          // Basic validation
          if (!inputRange || !outputColumn) {
            showError('Please fill in all required fields.');
            return;
          }
          
          // Process simple field if provided (and advanced options aren't)
          var schemaObj = null;
          if (simpleField && (!jsonSchema && !fieldPath)) {
            try {
              // Add debugging to check if functions exist
              console.log('SimpleOutputField functions available:', 
                typeof parseSimpleSyntax, 
                typeof generateSchemaFromSyntax, 
                typeof extractFieldPathFromSyntax);
              
              // Log the input
              console.log('Processing simple field:', simpleField);
              
              // Check if parseSimpleSyntax is available
              if (typeof parseSimpleSyntax !== 'function') {
                throw new Error('parseSimpleSyntax function is not available');
              }
              
              // Directly use SimpleOutputField functions instead of updating DOM
              var parsedSyntax = parseSimpleSyntax(simpleField);
              console.log('Parsed syntax:', parsedSyntax);
              
              if (parsedSyntax) {
                // Check if generateSchemaFromSyntax is available
                if (typeof generateSchemaFromSyntax !== 'function') {
                  throw new Error('generateSchemaFromSyntax function is not available');
                }
                
                // Generate schema directly
                schemaObj = generateSchemaFromSyntax(parsedSyntax);
                console.log('Generated schema:', schemaObj);
                
                // Check if extractFieldPathFromSyntax is available
                if (typeof extractFieldPathFromSyntax !== 'function') {
                  throw new Error('extractFieldPathFromSyntax function is not available');
                }
                
                // Get field path directly
                fieldPath = extractFieldPathFromSyntax(parsedSyntax);
                console.log('Extracted field path:', fieldPath);
                
                // Also update the UI fields for user feedback
                if (schemaObj) {
                  jsonSchema = JSON.stringify(schemaObj, null, 2);
                  document.getElementById('jsonSchema').value = jsonSchema;
                }
                if (fieldPath) {
                  document.getElementById('fieldPath').value = fieldPath;
                }
              }
            } catch (e) {
              console.error('Error processing simple field:', e.message, e.stack);
              showError('Error processing simple field: ' + e.message);
              return;
            }
          } else if (jsonSchema) {
            // Use the existing schema if provided
            try {
              schemaObj = JSON.parse(jsonSchema);
            } catch (e) {
              showError('Invalid JSON schema. Please check your format.');
              return;
            }
          }
          
          // Validate field path only allowed if schema is provided
          if (fieldPath && !schemaObj) {
            showError('Field path can only be used when a schema is provided.');
            return;
          }
          
          // Show spinner
          document.getElementById('spinner').style.display = 'block';
          
          // Hide previous alerts
          document.getElementById('successAlert').style.display = 'none';
          document.getElementById('errorAlert').style.display = 'none';
          
          console.log('Submitting with schema:', schemaObj);
          console.log('Submitting with field path:', fieldPath);
          
          // Call the server-side function
          google.script.run
            .withSuccessHandler(function(result) {
              // Hide spinner
              document.getElementById('spinner').style.display = 'none';
              
              if (result.success) {
                showSuccess(result.message);
              } else {
                showError(result.message);
              }
            })
            .withFailureHandler(function(error) {
              // Hide spinner
              document.getElementById('spinner').style.display = 'none';
              showError('Error: ' + error.message);
            })
            .processRange(inputRange, outputColumn, schemaObj, fieldPath);
        });
      });
      
      function showSuccess(message) {
        var alert = document.getElementById('successAlert');
        alert.textContent = message;
        alert.style.display = 'block';
      }
      
      function showError(message) {
        var alert = document.getElementById('errorAlert');
        alert.textContent = message;
        alert.style.display = 'block';
      }
    </script>
  </body>
</html> 